<!DOCTYPE html>
<!-- Shopping.html v2.1 -->
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#15d6e1">
<link rel="icon" href="icons/icon-192.png">
<link rel="manifest" href="manifest.webmanifest">
<title>Keto Einkaufsliste</title>
<style>
:root{--a:#15d6e1;--as:#30e5ec;--bg:#181c22;--c:#23273a;--t:#fff;--m:#91a0b5;--b:#2a2f49;--f:#7ef0f6;--rh:64px;--ts:48px;--r:12px;--ok:#1a7f37}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
html{font-size:18px}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--t);padding:env(safe-area-inset-top) env(safe-area-inset-right) calc(env(safe-area-inset-bottom) + 52px) env(safe-area-inset-left);min-height:100%;-webkit-text-size-adjust:100%}
.hidden{display:none!important}
header{text-align:center;padding:20px 12px 8px}
h1{color:var(--a);font-size:1.6rem;font-weight:700;margin:0 0 8px 0}
.search-bar{width:100%;max-width:420px;margin:0 auto 12px;display:flex;align-items:center;gap:8px}
#search{width:100%;padding:12px 14px;background:var(--c);border-radius:10px;border:1px solid var(--b);color:var(--t);font-size:1.05rem;outline:none}
#search::placeholder{color:var(--m)}
#search:focus{border-color:var(--f);box-shadow:0 0 0 3px color-mix(in oklab,var(--f),transparent 80%)}
.menu{display:grid;grid-template-columns:repeat(5,48px);justify-content:center;gap:10px;margin-bottom:8px;padding:4px 0}
.menu-btn{background:var(--c);color:var(--t);border:1px solid var(--b);border-radius:10px;cursor:pointer;touch-action:manipulation;inline-size:48px;block-size:48px;display:grid;place-items:center;transition:transform .06s ease-out,background .15s,border-color .15s, box-shadow .15s}
.menu-btn:focus-visible{outline:none;box-shadow:0 0 0 3px color-mix(in oklab,var(--f),transparent 70%);border-color:var(--f)}
.menu-btn:hover{background:color-mix(in oklab,var(--c),var(--a) 12%);border-color:var(--a)}
.menu-toggle{width:var(--ts);height:var(--ts);display:grid;place-items:center;padding:0;line-height:1}
.category{background:var(--c);border-radius:10px;margin:0 4px 12px;border:1px solid var(--b);overflow:clip}
.cat-header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;color:var(--a);font-size:1.05rem;font-weight:650;user-select:none;cursor:pointer;min-height:var(--ts)}
.cat-header .toggle{font-size:1.2rem;color:var(--m)}
.cat-items{padding:2px 14px 6px 14px}
.item-row{display:grid;grid-template-columns:var(--ts) 1fr auto;align-items:center;gap:10px;border-bottom:1px solid var(--b);min-height:var(--rh);padding:8px 0;will-change:background-color}
.item-row:last-child{border-bottom:none}
.item-row.selected{background:color-mix(in oklab,var(--as),white 75%);color:#0c0c0c}
.item-row label{display:flex;justify-content:space-between;align-items:baseline;cursor:pointer;font-size:1.12rem;line-height:1.3;gap:8px;max-height:calc(2*1.3em);overflow:hidden;text-overflow:ellipsis}
.item-amount{color:var(--m);font-size:0.95rem;flex-shrink:0;white-space:nowrap}
.checkbox{appearance:none;-webkit-appearance:none;inline-size:var(--ts);block-size:var(--ts);min-width:var(--ts);min-height:var(--ts);display:grid;place-items:center;border-radius:50%;border:2px solid var(--a);background:var(--c);cursor:pointer;position:relative;margin:0;transition:background-color 120ms ease,border-color 120ms ease}
.checkbox:focus-visible{outline:none;box-shadow:0 0 0 3px color-mix(in oklab,var(--f),transparent 70%);border-color:var(--f)}
.checkbox:checked{background:var(--a);border-color:var(--as)}
.checkbox:checked::before{content:"✓";color:#0c0c0c;font-weight:800;font-size:1.2rem;position:absolute;line-height:1}
.search-links{display:flex;gap:4px;align-items:center}
.search-btn{--icon:#bbb;background:var(--c);border:1px solid var(--b);color:var(--t);border-radius:6px;inline-size:40px;block-size:32px;display:flex;align-items:center;justify-content:center;text-decoration:none;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all .1s ease;gap:4px;padding:0 6px}
.search-btn:hover{background:var(--a);color:#0c0c0c;transform:scale(1.05)}
.search-btn:active{transform:scale(.95)}
.search-btn.billa{border-color:#e53e3e}
.search-btn.spar{border-color:#0066cc}
.search-btn.billa:hover{background:#e53e3e;border-color:#e53e3e;color:#fff}
.search-btn.spar:hover{background:#0066cc;border-color:#0066cc;color:#fff}
.icon{inline-size:14px;block-size:14px;background:var(--icon)}
.icon{mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="black"><path d="M21 20.3 16.6 15.9a8 8 0 1 0-.7.7L20.3 21 21 20.3zM10.5 17a6.5 6.5 0 1 1 0-13 6.5 6.5 0 0 1 0 13z"/></svg>') center/contain no-repeat;-webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="black"><path d="M21 20.3 16.6 15.9a8 8 0 1 0-.7.7L20.3 21 21 20.3zM10.5 17a6.5 6.5 0 1 1 0-13 6.5 6.5 0 0 1 0 13z"/></svg>') center/contain no-repeat}
.search-btn.win{--icon:var(--ok);border-color:var(--ok);box-shadow:0 0 0 2px color-mix(in oklab,var(--ok),transparent 70%) inset}
.status-wrap{position:fixed;left:0;right:0;bottom:0;padding-bottom:env(safe-area-inset-bottom);z-index:50}
.status-bar{background:var(--c);color:var(--a);font-weight:650;text-align:center;padding:12px 0;font-size:1.05rem;border-top:1px solid var(--b)}
.sr-live{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

/* Icon-only menu buttons */
.ico{inline-size:22px;block-size:22px;background:#d0d7e5}
.ico{mask:center/contain no-repeat;-webkit-mask:center/contain no-repeat}
.btn-install .ico{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox=\'0 0 24 24\'><path d=\'M12 3v10l3.5-3.5 1.4 1.4L12 17.3 7.1 10.9 8.5 9.5 12 13V3h0Z\'/><path d=\'M4 19h16v2H4z\'/></svg>')}
.btn-shortcut .ico{mask-image:url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M5 3h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-6l-4 4v-4H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z\"></path></svg>')}
.btn-selected .ico{mask-image:url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M3 12s3.5-6 9-6 9 6 9 6-3.5 6-9 6-9-6-9-6Zm9-3.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Z\"></path></svg>')}
.btn-share .ico{mask-image:url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M4 12l16-8-6 16-2-6-8-2Z\"></path></svg>')}
.btn-reset .ico{mask-image:url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M12 6V3l-4 4 4 4V8a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Z\"></path></svg>')}

/* iOS hint */
.install-hint{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000}
.install-hint .card{background:#23273a;border:1px solid #2a2f49;border-radius:12px;max-width:420px;padding:16px;color:#fff}
.install-hint h2{margin:0 0 8px 0;font-size:1.2rem;color:#15d6e1}
.install-hint p{margin:6px 0}
.install-hint button{margin-top:10px}

@media (max-width:420px){
  h1{font-size:1.45rem}
  .menu{grid-template-columns:repeat(5,48px)}
}
@media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important;scroll-behavior:auto!important}}
</style>
</head>
<body>
<header>
<h1>Keto Einkaufsliste</h1>
<div class="search-bar">
<input id="search" type="search" placeholder="Artikel/Kategorie suchen…" autocomplete="off" enterkeyhint="search">
<button class="menu-btn menu-toggle" id="menu" aria-haspopup="true" aria-expanded="false" title="Menü">⋯</button>
</div>
<div class="menu hidden" id="menuPopup" role="menu" aria-label="Aktionen">
  <button class="menu-btn btn-install" id="installPWA" role="menuitem" aria-label="Installieren" title="Installieren"><span class="ico" aria-hidden="true"></span></button>
  <button class="menu-btn btn-shortcut" id="downloadShortcut" role="menuitem" aria-label="Desktop-Verknüpfung" title="Desktop-Verknüpfung"><span class="ico" aria-hidden="true"></span></button>
  <button class="menu-btn btn-selected" id="showSelected" role="menuitem" aria-label="Nur Auswahl" title="Nur Auswahl"><span class="ico" aria-hidden="true"></span></button>
  <button class="menu-btn btn-share" id="sendList" role="menuitem" aria-label="Auswahl senden" title="Auswahl senden"><span class="ico" aria-hidden="true"></span></button>
  <button class="menu-btn btn-reset" id="resetList" role="menuitem" aria-label="Zurücksetzen" title="Zurücksetzen"><span class="ico" aria-hidden="true"></span></button>
</div>
</header>

<main id="list"></main>

<div class="status-wrap">
<p class="sr-live" aria-live="polite" id="liveCounter"></p>
<div class="status-bar" id="statusBar">0 ausgewählt · 0 sichtbar</div>
</div>

<script id="prices-data" type="application/json">
[
  { "key": "brokkoli",              "billa": 2.49, "spar": 2.39 },
  { "key": "blumenkohl",            "billa": 2.49, "spar": 2.59 },
  { "key": "zucchini",              "billa": 1.49, "spar": 1.39 },
  { "key": "spinat blattspinat",    "billa": 2.99, "spar": 3.49 },
  { "key": "paprika mix",           "billa": 3.79, "spar": 3.59 },
  { "key": "champignons",           "billa": 2.49, "spar": 2.79 },
  { "key": "rucola",                "billa": 1.79, "spar": 1.79 },
  { "key": "tomaten",               "billa": 2.69, "spar": 2.79 },
  { "key": "gurken",                "billa": 1.39, "spar": 1.49 },
  { "key": "zwiebeln",              "billa": 1.29, "spar": 1.29 },
  { "key": "knoblauch",             "billa": 0.89, "spar": 0.99 },
  { "key": "zitronen",              "billa": 0.59, "spar": 0.55 },
  { "key": "avocado",               "billa": 1.49, "spar": 1.69 },
  { "key": "petersilie dill schnittlauch", "billa": 1.29, "spar": 1.29 },
  { "key": "skyr becher",           "billa": 1.79, "spar": 1.89 },
  { "key": "magerquark",            "billa": 1.09, "spar": 1.19 },
  { "key": "griechisches joghurt 10", "billa": 3.49, "spar": 3.69 },
  { "key": "cottage cheese huettenkaese", "billa": 1.19, "spar": 1.29 },
  { "key": "gouda",                 "billa": 3.19, "spar": 3.49 },
  { "key": "parmesan stueck",       "billa": 5.99, "spar": 6.29 },
  { "key": "freilandeier",          "billa": 3.49, "spar": 3.59 },
  { "key": "butter",                "billa": 2.99, "spar": 3.19 },
  { "key": "huehnerfilet",          "billa": 11.99, "spar": 12.49 },
  { "key": "rind faschiertes mager","billa": 18.64, "spar": 18.99 },
  { "key": "lachsfilet",            "billa": 8.49, "spar": 8.99 },
  { "key": "seehechtfilet",         "billa": 6.99, "spar": 7.49 },
  { "key": "garnelen geschaelt",    "billa": 6.49, "spar": 6.99 },
  { "key": "thunfisch in wasser",   "billa": 1.99, "spar": 2.19 },
  { "key": "sardellenfilets",       "billa": 2.79, "spar": 2.99 },
  { "key": "gruenen oliven entsteint","billa": 1.49, "spar": 1.59 },
  { "key": "pesto alla genovese",   "billa": 3.69, "spar": 2.69 },
  { "key": "passierte tomaten",     "billa": 1.94, "spar": 1.99 },
  { "key": "sojasauce",             "billa": 2.17, "spar": 2.29 },
  { "key": "olivenoel",             "billa": 9.99, "spar": 10.49 },
  { "key": "kokosoel",              "billa": 4.49, "spar": 4.59 },
  { "key": "leinsamen chiasamen",   "billa": 2.99, "spar": 3.49 },
  { "key": "pekannuesse",           "billa": 4.99, "spar": 5.29 },
  { "key": "paranuesse",            "billa": 4.99, "spar": 5.19 },
  { "key": "kakao nibs",            "billa": null, "spar": null },
  { "key": "konjaknudeln",          "billa": 2.47, "spar": 2.79 },
  { "key": "blumenkohlreis",        "billa": null, "spar": null },
  { "key": "beeren mix",            "billa": 2.99, "spar": 3.29 }
]
</script>

<script>
/* ===== CSV & bestehende UI-Logik (leicht angepasst) ===== */
const d=`Kategorie,Menge,Bezeichnung
Obst & Gemüse,"1,2 kg",Brokkoli frisch
,"1,0 kg",Blumenkohl
,"1,5 kg",Zucchini
,600 g,Spinat
,6 Stk,Paprika Mix
,500 g,Champignons
,250 g,Rucola
,6 Stk,Tomaten
,2 Stk,Gurken
,6 Stk,Zwiebeln
,,Knoblauch 1 Knolle
,4 Stk,Zitronen
,1 kg,Beeren-Mix TK
,2 Stk,Avocado
,1 Bund,"Petersilie, Dill, Schnittlauch je"
Milchprodukte & Eier,500 g,Skyr natur  Becher
,1 kg,Magerquark
,1 kg,Griechisches Joghurt 10%
,500 g,Cottage Cheese
,200 g,Gouda 6 Monate gereift
,150 g,Parmesan am Stück
,20 Stk,Freilandeier
,250 g,Ja! Natürlich Weidebutter
Fleisch & Fisch,"1,6 kg",Hühnerfilet
,800 g,Rind Faschiertes mager
,600 g,Lachsfilet TK
,600 g,Seehechtfilet TK
,500 g,Garnelen geschält TK
,3 Dosen,Thunfisch in Wasser
,1 Glas,Sardellenfilets
Vorrat & Feinkost,200 g,Grüne Oliven entsteint
,1 Glas,Pesto alla Genovese
,500 ml,Passierte Tomaten
,250 ml,Sojasauce
,500 ml,Bio Olivenöl Extra Vergine
,250 ml,Kokosöl
,200 g,Lein\Chiasamen
,150 g,Pekannüsse
,150 g,Paranüsse
,100 g,Kakao-Nibs
,,"Salz, Pfeffer"
,,FlavDrops
,270 g,Konjaknudeln
Tiefkühl,450 g,Bio Blattspinat
,2 Beutel,Blumenkohl
,1 kg,Beeren-Mix TK`;

(function suppressErrors(){
  try{
    window.onerror=function(){return true};
    window.addEventListener("error",e=>{try{e.preventDefault()}catch(_){}} ,true);
    window.addEventListener("unhandledrejection",e=>{try{e.preventDefault()}catch(_){}} );
    var c=console; ["error","warn"].forEach(k=>{try{c[k]=function(){}}catch(_){}} );
  }catch(_){}
})();

function parseCSV(data){
  const lines=data.split("\n").slice(1);
  const categories={};
  let currentCat="";
  for(const line of lines){
    const parts=line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/g).map(s=>s.replace(/^"|"$/g,"").trim());
    let[cat,menge,bez]=parts;
    if(cat)currentCat=cat;
    if(!categories[currentCat])categories[currentCat]=[];
    if(bez)categories[currentCat].push({amount:menge,name:bez});
  }
  return categories;
}

/* ===== Preis-/Vergleichslogik ===== */
function normalize(s){
  return String(s||"")
    .toLowerCase()
    .replace(/\s+/g," ")
    .replace(/[^\wäöüß0-9 ]/g,"")
    .trim();
}
function optimizeSearchTerm(productName){
  return productName
    .replace(/\([^)]*\)/g,"")
    .replace(/\d+[×x]\s*/g,"")
    .replace(/\s+/g," ")
    .replace(/bio\s+/gi,"")
    .replace(/ja!\s*naturlich\s+/gi,"")
    .replace(/tk\s*$/gi,"")
    .replace(/\s*\d+\s*monate\s+gereift/gi,"")
    .replace(/\s*am\s+stuck/gi,"")
    .replace(/\s*entsteint/gi,"")
    .replace(/\s*geschalt/gi,"")
    .replace(/\s*in\s+wasser/gi,"")
    .replace(/extra\s+vergine/gi,"")
    .replace(/frisch\s*$/gi,"")
    .replace(/\s*oder\s+.*/gi,"")
    .replace(/,.*/,"")
    .trim();
}
function euro(n){
  if(n==null || isNaN(n)) return "–";
  return Number(n).toFixed(2).replace(".", ",") + " €";
}

let priceIndex = new Map();
(function loadPrices(){
  try{
    const raw=document.getElementById("prices-data")?.textContent||"[]";
    const arr=JSON.parse(raw);
    for(const it of arr){
      if(!it||!it.key) continue;
      priceIndex.set(normalize(it.key), {billa: it.billa, spar: it.spar});
    }
  }catch(_){}
})();

function getPricesForName(productName){
  const key = normalize(optimizeSearchTerm(productName));
  const rec = priceIndex.get(key);
  return rec || null;
}

function generateSearchLinks(productName){
  const searchTerm = optimizeSearchTerm(productName);
  const billaUrl=`https://shop.billa.at/suche/${encodeURIComponent(searchTerm)}`;
  const sparUrl=`https://www.interspar.at/shop/lebensmittel/search/?q=${encodeURIComponent(searchTerm)}`;
  return{billa:billaUrl,spar:sparUrl,term:searchTerm};
}

/* ===== Bestehender State/UI ===== */
const categories=parseCSV(d);
const LS_SELECTED="ek_selected";
const LS_COLLAPSED="ek_collapsed";
const LS_ONLYSEL="ek_onlySelected";
const LS_FILTER="ek_filter";

let selected=JSON.parse(localStorage.getItem(LS_SELECTED)||"{}");
let collapsed=JSON.parse(localStorage.getItem(LS_COLLAPSED)||"{}");
let onlySelected=JSON.parse(localStorage.getItem(LS_ONLYSEL)||"false");
let filter=localStorage.getItem(LS_FILTER)||"";

function saveLocal(){
  localStorage.setItem(LS_SELECTED,JSON.stringify(selected));
  localStorage.setItem(LS_COLLAPSED,JSON.stringify(collapsed));
  localStorage.setItem(LS_ONLYSEL,JSON.stringify(onlySelected));
  localStorage.setItem(LS_FILTER,filter);
}

const listEl=document.getElementById("list");
const statusEl=document.getElementById("statusBar");
const liveEl=document.getElementById("liveCounter");
const searchEl=document.getElementById("search");
searchEl.value=filter;

function itemMatchesFilter(cat,item){
  if(!filter)return true;
  const t=(item.name+" "+(item.amount||"")+" "+cat).toLowerCase();
  return t.includes(filter.toLowerCase());
}

function computeVisibleAndSelected(){
  let visible=0,sel=0;
  for(const[cat,items]of Object.entries(categories)){
    for(const item of items){
      const key=cat+"|"+item.name;
      const inFilter=itemMatchesFilter(cat,item);
      const inOnly=!onlySelected||!!selected[key];
      if(inFilter&&inOnly){
        visible++;
        if(selected[key])sel++;
      }
    }
  }
  return{visible,sel};
}

function updateStatus(){
  const{visible,sel}=computeVisibleAndSelected();
  const text=`${sel} ausgewählt · ${visible} sichtbar`;
  statusEl.textContent=text;
  liveEl.textContent=text;
}

/* ===== Markierung & Hover-Preis ===== */
function applyWinAndTooltip(billaBtn, sparBtn, prices){
  try{
    billaBtn.classList.remove("win");
    sparBtn.classList.remove("win");
    billaBtn.title = "BILLA";
    sparBtn.title = "SPAR";
    if(!prices) return;

    const pb = typeof prices.billa==="number" ? prices.billa : null;
    const ps = typeof prices.spar==="number" ? prices.spar : null;

    if(pb!=null) billaBtn.title = "BILLA: " + euro(pb);
    if(ps!=null) sparBtn.title = "SPAR: "  + euro(ps);

    if(pb!=null && ps!=null){
      if(pb < ps) billaBtn.classList.add("win");
      else if(ps < pb) sparBtn.classList.add("win");
      else { billaBtn.classList.add("win"); sparBtn.classList.add("win"); }
    }else if(pb!=null){
      billaBtn.classList.add("win");
    }else if(ps!=null){
      sparBtn.classList.add("win");
    }
  }catch(_){}
}

/* ===== Render ===== */
function renderList(){
  listEl.innerHTML="";
  for(const[cat,items]of Object.entries(categories)){
    const shownItems=items.filter(it=>itemMatchesFilter(cat,it)&&(!onlySelected||selected[cat+"|"+it.name]));
    if(!shownItems.length)continue;

    const catDiv=document.createElement("section");
    catDiv.className="category";
    const isCollapsed=onlySelected?false:!!collapsed[cat];
    catDiv.innerHTML=`<div class="cat-header" data-cat="${cat}" aria-expanded="${!isCollapsed}"><span>${cat}</span><span class="toggle" aria-hidden="true">${isCollapsed?"▼":"▲"}</span></div><div class="cat-items ${isCollapsed?"hidden":""}"></div>`;

    const itemsWrap=catDiv.querySelector(".cat-items");
    for(const item of shownItems){
      const key=cat+"|"+item.name;
      const checked=!!selected[key];

      const row=document.createElement("div");
      row.className="item-row"+(checked?" selected":"");
      row.dataset.key=key;

      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.className="checkbox";
      cb.id=key;
      cb.checked=checked;
      cb.setAttribute("aria-label",item.name);

      const label=document.createElement("label");
      label.htmlFor=key;
      label.innerHTML=`<span>${item.name}</span>${item.amount?`<span class="item-amount">${item.amount}</span>`:""}`;

      const linksContainer=document.createElement("div");
      linksContainer.className="search-links";

      const {billa: bUrl, spar: sUrl} = generateSearchLinks(item.name);

      const billaLink=document.createElement("a");
      billaLink.href=bUrl; billaLink.target="_blank";
      billaLink.className="search-btn billa";
      billaLink.setAttribute("aria-label","Bei BILLA suchen");
      billaLink.innerHTML='<span class="icon" aria-hidden="true"></span><small>B</small>';

      const sparLink=document.createElement("a");
      sparLink.href=sUrl; sparLink.target="_blank";
      sparLink.className="search-btn spar";
      sparLink.setAttribute("aria-label","Bei SPAR suchen");
      sparLink.innerHTML='<span class="icon" aria-hidden="true"></span><small>S</small>';

      const prices = getPricesForName(item.name);
      applyWinAndTooltip(billaLink, sparLink, prices);

      linksContainer.appendChild(billaLink);
      linksContainer.appendChild(sparLink);

      row.appendChild(cb);
      row.appendChild(label);
      row.appendChild(linksContainer);
      itemsWrap.appendChild(row);
    }
    listEl.appendChild(catDiv);
  }
  updateStatus();
}

/* ===== Events ===== */
listEl.addEventListener("change",e=>{
  if(!(e.target instanceof HTMLInputElement))return;
  if(!e.target.classList.contains("checkbox"))return;

  const key=e.target.id;
  const checked=e.target.checked;
  selected[key]=checked;

  const row=e.target.closest(".item-row");
  if(row)row.classList.toggle("selected",checked);

  saveLocal();
  updateStatus();

  if(onlySelected&&!checked){
    const rowEl=row;
    if(rowEl){
      rowEl.style.opacity="0";
      rowEl.style.transition="opacity 120ms ease";
      setTimeout(()=>{
        const wrapper=rowEl.closest(".cat-items");
        rowEl.remove();
        if(wrapper&&!wrapper.children.length){
          wrapper.closest(".category")?.remove();
        }
        updateStatus();
      },120);
    }
  }
});

listEl.addEventListener("click",e=>{
  const header=e.target.closest(".cat-header");
  if(!header)return;
  const cat=header.dataset.cat;
  const section=header.parentElement;
  const items=section.querySelector(".cat-items");
  const toggleIcon=header.querySelector(".toggle");
  const newCollapsed=!collapsed[cat];
  collapsed[cat]=newCollapsed;
  items.classList.toggle("hidden",newCollapsed);
  header.setAttribute("aria-expanded",String(!newCollapsed));
  toggleIcon.textContent=newCollapsed?"▼":"▲";
  saveLocal();
});

document.getElementById("search").addEventListener("input",e=>{
  filter=e.target.value;
  saveLocal();
  renderList();
});

const menuBtn=document.getElementById("menu");
const menu=document.getElementById("menuPopup");
const openMenu=()=>{menu.classList.remove("hidden");menuBtn.setAttribute("aria-expanded","true");};
const closeMenu=()=>{menu.classList.add("hidden");menuBtn.setAttribute("aria-expanded","false");};
menuBtn.addEventListener("click",()=>{menu.classList.contains("hidden")?openMenu():closeMenu();});
document.addEventListener("click",e=>{ if(!menu.contains(e.target)&&e.target!==menuBtn&&!menuBtn.contains(e.target))closeMenu(); });

document.getElementById("showSelected").addEventListener("click",()=>{
  onlySelected=!onlySelected;
  saveLocal();
  renderList();
  closeMenu();
});

document.getElementById("sendList").addEventListener("click",async()=>{
  const selectedByCat={};
  Object.entries(selected).filter(([,v])=>v).forEach(([k])=>{
    const[cat,name]=k.split("|");
    if(!selectedByCat[cat])selectedByCat[cat]=[];
    selectedByCat[cat].push(name);
  });

  const lines=[];
  Object.entries(selectedByCat).forEach(([cat,items])=>{
    lines.push(`${cat}:`);
    items.forEach(item=>lines.push(`  ${item}`));
    lines.push("");
  });

  const payload=lines.join("\n").trim()||"Keine Auswahl";
  try{
    if(navigator.share){
      await navigator.share({title:"Meine Einkaufsliste",text:payload});
    }else if(navigator.clipboard&&window.isSecureContext){
      await navigator.clipboard.writeText(payload);
      alert("Liste in die Zwischenablage kopiert.");
    }else{
      window.location.href="mailto:?subject=Einkaufsliste&body="+encodeURIComponent(payload);
    }
  }catch{}
  closeMenu();
});

document.getElementById("resetList").addEventListener("click",()=>{
  selected={}; filter=""; onlySelected=false;
  document.getElementById("search").value="";
  saveLocal(); renderList(); closeMenu();
});

/* Start */
renderList();
</script>
<script src="install.js" defer></script>
</body>
</html>
